var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,i=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,a=(e,t)=>{for(var n in t||(t={}))s.call(t,n)&&i(e,n,t[n]);if(r)for(var n of r(t))o.call(t,n)&&i(e,n,t[n]);return e},c=(e,r)=>t(e,n(r)),l=(e,t)=>{var n={};for(var i in e)s.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(null!=e&&r)for(var i of r(e))t.indexOf(i)<0&&o.call(e,i)&&(n[i]=e[i]);return n};import{v as u,n as h,e as d,u as m,S as g,C as p,l as f,a as w,R as y,r as b,b as v,L as E,f as k,m as x,c as $,d as C,O as S,g as N,h as A,i as R,U as T,j as O,k as P,o as j,p as I,q as L,s as D,B as M}from"./vendor.ee5b91f1.js";const F=navigator.userAgent||navigator.vendor||window.opera,q=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(F)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw-(n|u)|c55\/|capi|ccwa|cdm-|cell|chtm|cldc|cmd-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc-s|devi|dica|dmob|do(c|p)o|ds(12|-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(-|_)|g1 u|g560|gene|gf-5|g-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd-(m|p|t)|hei-|hi(pt|ta)|hp( i|ip)|hs-c|ht(c(-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i-(20|go|ma)|i230|iac( |-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|-[a-w])|libw|lynx|m1-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|-([1-8]|c))|phil|pire|pl(ay|uc)|pn-2|po(ck|rt|se)|prox|psio|pt-g|qa-a|qc(07|12|21|32|60|-[2-7]|i-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h-|oo|p-)|sdk\/|se(c(-|0|1)|47|mc|nd|ri)|sgh-|shar|sie(-|m)|sk-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h-|v-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl-|tdg-|tel(i|m)|tim-|t-mo|to(pl|sh)|ts(70|m-|m3|m5)|tx-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas-|your|zeto|zte-/i.test(F.substr(0,4)),z=(e,t)=>e.w===t.w&&e.h===t.h,U=(e,t)=>e.w===t.w&&e.h>t.h,H={w:window.innerWidth,h:window.innerHeight};let _={w:window.innerWidth,h:window.innerHeight},G={w:window.innerWidth,h:window.innerHeight},B=!1;const W=d(),V=W.subscribe;function J(e){B!==e&&(B=e,W(e))}q&&window.addEventListener("resize",(()=>{_=G,G={w:window.innerWidth,h:window.innerHeight},(z(G,H)&&U(G,_)||z(_,H)&&U(_,G))&&J(!1)}));const K=new Set;let Q=!1;const X=d(),Y=X.subscribe;function Z(e){const t=function(){const e={};return K.add(e),ee(),()=>{K.delete(e),ee()}}();return e.finally(t)}function ee(){const e=Boolean(K.size);e!==Q&&(Q=e,X(e))}function te(e,t={}){const n="body"in t&&"string"!=typeof t.body?JSON.stringify(t.body):t.body,r=c(a({},t),{body:n});return Z(fetch(e,r).then((e=>Promise.all([e,e.text()]))).then((([t,n])=>(function(e,t,n){const r=Math.floor(e/100);let s=se[e];if(console.debug(`HTTP[${e} ${s}]: ${t}`),r<4)return;s||(4===r?s="Unknown client error":5===r&&(s="Unknown server error"));throw new re(e,s||"Unknown status",n)}(t.status,e,n),function(e){const t=e.headers.get("content-type");return!!t&&t.toLowerCase().includes("application/json")}(t)?JSON.parse(n):n))))}const ne=(e,t=null,n={})=>te(e,a({method:"POST",body:t},n));class re extends Error{constructor(e,t,n){super(`${e}: ${t}`),this.status=e,this.body=n}}const se={100:"Continue",101:"Switching Protocol",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choice",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"unused",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a teapot",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"};function oe(e){const t=`https://api.github.com${e}`,n=`p=${Date.now()}`;return t.includes("?")?`${t}&${n}`:`${t}?${n}`}function ie(e){return{Authorization:`token ${e}`}}class ae{constructor(e){this.token=e}send(e,t){const n={query:this.buildQuery(e,t),variables:t},r=ie(this.token);return ne(oe("/graphql"),n,{headers:r}).then((e=>{const{errors:t}=e;return t&&console.error("GraphQL errors:",t),e}))}buildQuery(e,t){const n=Object.keys(t);if(!n.length)return`query {${e}}`;return`query(${n.map((e=>`$${e}: String!`)).join(", ")}) {${e}}`}}var ce,le;(le=ce||(ce={})).Json="application/vnd.github.v3+json",le.Raw="application/vnd.github.v3.raw",le.Html="application/vnd.github.v3.html";class ue{constructor(e){this.token=e}GET(e,t){return((e,t={})=>te(e,t))(oe(e),this.withAuth(t))}DELETE(e){return((e,t={})=>te(e,a({method:"DELETE"},t)))(oe(e),this.withAuth())}PUT(e,t){return((e,t=null,n={})=>te(e,a({method:"PUT",body:t},n)))(oe(e),t,this.withAuth())}POST(e,t){return ne(oe(e),t,this.withAuth())}PATCH(e,t){return((e,t=null,n={})=>te(e,a({method:"PATCH",body:t},n)))(oe(e),t,this.withAuth())}withAuth({mediaType:e=ce.Json}={}){return{headers:c(a({},ie(this.token)),{Accept:e})}}}const he={has_issues:!1,has_projects:!1,has_wiki:!1,auto_init:!0,allow_merge_commit:!0,allow_squash_merge:!1,allow_rebase_merge:!1,delete_branch_on_merge:!1,has_downloads:!1,is_template:!1};class de{constructor(e,t,n){this.token=e,this.owner=t,this.name=n,this.commiting=!1,this.branch="main",this.rest=new ue(e),this.gql=new ae(e)}get url(){return`/repos/${this.owner}/${this.name}`}get isCommiting(){return this.commiting}exists(){return this.rest.GET(this.url).then((()=>!0),(()=>!1))}async create(e,t){try{await this.rest.POST("/user/repos",a({name:this.name,description:e,homepage:"",private:t,visibility:t?"private":"public"},he))}catch(n){throw console.error(n),n}}async createIfNecessary(e,t){return!(await this.exists())&&(await this.create(e,t),!0)}async readDir(e){const t=e.replace(/^\*|\*$/g,""),{data:{repository:{files:n}}}=await this.gql.send("\n    repository(owner: $owner, name: $repo) {\n      files: object(expression: $path) {\n        ... on Tree {\n          entries {\n            path\n            object {\n              ... on Blob {\n                text\n              }\n            }\n          }\n        }\n      }\n    }\n  ",this.getFileVars(t));return n?n.entries.map((e=>[e.path,e.object.text])):[]}async getReadme(){return this.rest.GET(`${this.url}/readme`,{mediaType:ce.Raw})}async readFile(e){const t=await this.rest.GET(`${this.url}/contents/${e}`,{mediaType:ce.Raw});if(Array.isArray(t))throw new Error(`${this.url}/${e} is a directory`);return t}async writeFile(e,t,n){await this.rest.PUT(`${this.url}/contents/${e}`,{message:n,content:t})}commit(e,t,n=!1){const{owner:r,name:s,branch:o,token:i}=this,a={token:i,owner:r,repo:s,branch:o,files:t,message:e};return this.commiting=!0,ne("https://pensieve.amatiasq.com/commit",a,{keepalive:n}).finally((()=>this.commiting=!1))}async readFileCool(e,t){return this.gql.send(function(e){return`\n    repository(owner: $owner, name: $repo) {\n      object(expression: $path) {\n        ... on Blob {\n          ${e}\n        }\n      }\n    }\n  `}(t),this.getFileVars(e)).then((e=>{var t;return null==(t=e.data.repository.file)?void 0:t.text}))}getFileVars(e){return{owner:this.owner,repo:this.name,path:`${this.branch}:${e}`}}}const me={},ge=m.v4();function pe(e){const t=d();me[e]=t;return[t=>{setTimeout((()=>postMessage({id:ge,type:e,data:t},location.origin)),10)},t.subscribe]}function fe(e){return JSON.stringify(e,null,2)}function we(e){const t=e.replace(/[^:]\/\/[^\n]+\n/g,"");try{return JSON.parse(t)}catch(n){const[e]=n.message.split(/\s/g).reverse();throw console.warn(`Error in JSON (${n.message}):\n${t.substr(e-100,200)}`),n}}function ye(e=new Date){return`${e.getFullYear()}-${ve(e.getMonth()+1)}-${ve(e.getDate())} ${ve(e.getHours())}:${ve(e.getMinutes())}:${ve(e.getSeconds())}`}function be(e){return new Date(e)}function ve(e){return e<10?`0${e}`:`${e}`}function Ee(e,t){return(null!=e&&null!=t||e===t)&&fe(e)===fe(t)}function ke(e){const t=e.trim(),n=t.indexOf("\n"),r=-1===n?t:t.substr(0,n),s=function(e){const t=e.match(/(\.\w+)+$/);return t?t[0]:".md"}(r),o=function(e,t){const n=function(e){const t=function(e){return{".sql":"--",".md":"#",".sh":"#",".js":"//",".ts":"//",".cs":"//",".fs":"//"}[e]||"//"}(e);return new RegExp(`^\\s*(${t})+`)}(t);return e.trim().replace(n,"").trim()}(r,s),[i,a]=o.split("/").reverse().map((e=>e.trim()));return{title:i,group:a,extension:s,content:e}}window.addEventListener("message",(e=>{const t=me[e.data.type];"function"==typeof t&&(console.debug(`🚎 ${e.data.type}`,e.data.data),t(e.data.data))}));const xe={autosave:5,reloadIfAwayForSeconds:5,renderIndentGuides:!1,rulers:[],sidebarVisible:!0,sidebarWidth:400,starNewNotes:!0,tabSize:2,wordWrap:!0,highlight:{"~~[^~]*~~":"#505050","@(\\w|-)+":"#6fb9ef"},links:{"\\[(\\w+/\\w+)]":"https://github.com/$1"}};function $e(e,t){return fe(e)===fe(t)}const Ce={"CTRL+TAB":"goBack","CTRL+SHIFT+TAB":"goForward","ALT+N":"toggleWordWrap","CMD+S":"save","CMD+,":"settings","CMD+B":"hideSidebar","CMD+W":"goHome","CMD+N":"newNote","CMD+SHIFT+E":"clearFilter","CTRL+S":"save","CTRl+,":"settings","CTRL+B":"hideSidebar","CTRL+W":"goHome","CTRL+N":"newNote"};function Se(e,t,n,r=(()=>!0)){let s=!1,o=!1;return new Promise(((i,a)=>{t.finally((()=>o=!0)).then((e=>{s?n(e):i(e)}),(e=>{s&&a(e)})),e.then((e=>{r(e)&&(s=!0,i(e))}),(e=>{s=!0,o&&a(e)}))}))}function Ne(e,t){return{urgent:e&&e.urgent||!1,reason:e&&e.reason||t}}class Ae{constructor(e,t,n){this.store=e,this.key=t,this.defaultValue=n}get isCached(){return this.store.localHas(this.key)}read(){return this.store.read(this.key).then((e=>e||this.defaultValue),(()=>this.defaultValue))}readAsap(e){const t=e=>e||this.defaultValue;return Se(this.store.readLocal(this.key).then(t),this.store.readRemote(this.key).then(t),e)}write(e,t){const n=Ne(t,`Write ${this.key}`);return this.store.write(this.key,e,n)}delete(e){const t=Ne(e,`Delete ${this.key}`);return this.store.delete(this.key,t)}}class Re extends Ae{constructor(e,t,n){super(e,t,fe(n)),this.defaultJson=n;const[r,s]=pe(`json:changed:${t}`);this.emitChange=r,this.onChange=s}get(){return this.read().then((e=>e?we(e):this.defaultJson)).catch((()=>this.defaultJson))}set(e,t){const n=fe(e),r=Ne(t,`Set ${this.key}`);return this.write(n,r)}async write(e,t){this.emitChange(we(e)),await super.write(e,t)}}const Te=()=>{},Oe=new Map;class Pe{constructor(e,t,n){this.id=e,this.meta=t,this.content=n;const[r,s]=pe(`note:title:${e}`),[o,i]=pe(`note:deleted:${e}`),[a,c]=pe(`note:changed:${e}`),[l,u]=pe(`note:content-changed:${e}`);if(Oe.has(e))throw new Error(`Created RemoteNote twice with same id: ${e}`);this.emitChange=a,this.emitContentChange=l,this.emitDelete=o,this.emitDraft=r,this.onChange=c,this.onContentChange=u,this.onDelete=i,this.onDraft=s}get title(){const e=this.get();return e?e.title:"(unknown)"}get hasCachedContent(){return Promise.resolve(!0)}getCache(){return Oe.get(this.id)||null}get(){return this.getCache()}async delete(e){const t=Ne(e,`Delete note "${this.title}"`);await Promise.all([this.meta.delete(t).catch(Te),this.content.delete(t).catch(Te)]),this.emitDelete()}draft(e){const t=this.getCache();if(!t)return;const{title:n,group:r}=ke(e);this.emitDraft(c(a({},t),{title:n,group:r}))}async read(){localStorage.getItem("URGENT_SAVE")===this.id&&(localStorage.removeItem("URGENT_SAVE"),await new Promise((e=>setTimeout(e,500))));const e=await this.content.readAsap((e=>{this.updateFromContent(e),this.emitContentChange(e)}));return e&&this.updateFromContent(e),e}async write(e,t){t&&t.urgent&&localStorage.setItem("URGENT_SAVE",this.id);const{title:n}=ke(e),r=Ne(t,`Update note "${this.title}"${n!==this.title?` renamed "${n}"`:""}`);await Promise.all([this.updateFromContent(e,r),this.content.write(e,r)]),this.emitContentChange(e)}setGroup(e,t){const n=Ne(t,`Add note to group "${e}"`);return this.update((t=>c(a({},t),{group:e})),n)}toggleFavorite(e){const t=Ne(e,`Toggle "${this.title}" favorite`);return this.update((e=>c(a({},e),{favorite:!e.favorite})),t)}async push(e){const{id:t}=this;if(e.id!==t)throw new Error(`Pushing note with id ${e.id} into RemoteNote with id ${t}`);const n=!Ee(this.getCache(),e);Oe.set(t,e),n&&this.emitChange(e)}async update(e,t){const n=await this.meta.get(),r=e(n),s=ye();return Ee(c(a({},n),{modified:s}),c(a({},r),{modified:s}))||(await this.meta.set(r,t),this.emitChange(r)),r}async updateFromContent(e,t){const{title:n,group:r}=ke(e),s=await this.update((e=>c(a({},e),{title:n,group:r,modified:ye()})),t);return Oe.set(this.id,s),s}}const je=e=>`meta/${e}.json`,Ie=e=>`note/${e}`,Le=e=>e.trim().replace(/,$/,"");function De(e){const{group:t,title:n}=ke(e);return{id:m.v4(),title:n,group:t,favorite:!0,created:ye(),modified:ye()}}class Me extends class{constructor(e){this.store=e,this.notes=new Map,this.settings=new Re(this.store,"settings.json",xe),this.shortcuts=new Re(this.store,"shortcuts.json",Ce);const[t,n]=pe("notes-created");this.emitNotesCreate=t,this.onNotesCreated=n}async all(){const e="meta/*",t=e=>t=>(console.log(`Notes found in ${e}`,Object.keys(t).length),t);return Se(this.store.readAllLocal(e).then(t("local")),this.store.readAllRemote(e).then(t("remote")),(e=>this.synchronize(e)),(e=>Boolean(Object.keys(e).length))).then((e=>Object.values(e).map((e=>{const t=we(Le(e));return this.updateRemote(t.id,t),t}))))}synchronize(e){const t=[],n=new Set(...this.notes.keys());for(const[,r]of Object.entries(e)){const e=we(Le(r)),s=n.delete(e.id);this.note(e.id).push(e),s||t.push(e)}t.length&&this.emitNotesCreate(t);for(const r of n)this.store.deleteLocal(je(r)),this.store.deleteLocal(Ie(r))}note(e){return this.notes.has(e)?this.notes.get(e):this.createRemote(e,c(a({},De("")),{id:e}))}create(e){const t=De(e),{id:n}=t,r=this.createRemote(n,t),s=`Create note "${t.title}"`;return Promise.all([this.store.write(je(n),fe(t),{reason:s}),r.write(e,{reason:s})]),this.emitNotesCreate([t]),r}updateRemote(e,t){if(!this.notes.get(e))return this.createRemote(e,t);const n=this.notes.get(e);return n.push(t),n}createRemote(e,t){const n=new Pe(e,new Re(this.store,je(e),t),new Ae(this.store,Ie(e),""));return this.notes.set(e,n),n.push(t),n}}{constructor(e,...t){super(...t),this.username=e}}let Fe=0;const qe=Boolean(localStorage.getItem("debug"));function ze(e,t,n){if(!qe)return;const r=e.constructor.name;t.forEach((t=>{const s=e[t];e[t]=(...o)=>{const i="  ".repeat(Fe++),a=n?` [${n}]`:"";console.debug(`${i}🟢 ${r}.${t}${a}`,o[0]);const c=s.apply(e,o);return console.debug(`${i}🔴 ${r}.${t}${a}`),Fe--,c}}))}class Ue{constructor(e){this.duration=e,this.data=new Map,this.time=new Map}has(e){const t=this.time.get(e);if(null==t)return!1;const n=(Date.now()-t)/1e3>this.duration;return n&&(this.time.delete(e),this.data.delete(e)),!n}get(e){return this.data.get(e)}set(e,t){this.time.set(e,Date.now()),this.data.set(e,t)}}class He{constructor(e,t,n){this.store=e,this.seconds=t,this.readAllCache=new Ue(this.seconds),this.cache=new Ue(this.seconds),ze(this,["readAll","read","write","delete"],n)}has(e){return this.store.has(e)}readAll(e){if(this.readAllCache.has(e))return this.readAllCache.get(e);const t=this.store.readAll(e);return this.readAllCache.set(e,t),t}read(e){if(this.cache.has(e))return this.cache.get(e);const t=this.store.read(e);return this.cache.set(e,t),t}write(e,t,n){return this.cache.set(e,Promise.resolve(t)),this.store.write(e,t,n)}delete(e,t){return this.cache.set(e,Promise.resolve(null)),this.store.delete(e,t)}}class _e{constructor(e){this.forage=e,this.keys=null,ze(this,["readAll","read","write","delete"])}async has(e){const t=this.keys||await this.forage.keys();return this.keys||(this.keys=t,setTimeout((()=>this.keys=null),3e3)),t.includes(e)}async readAll(e){const t=function(e){const t=e.startsWith("*")?"":"^",n=e.endsWith("*")?"":"$",r=e.replace(/^\*|\*$/g,"");return new RegExp(`${t}${r}${n}`)}(e),n=(await this.forage.keys()).filter((e=>t.test(e))).map((async e=>[e,await this.read(e)])),r=(await Promise.all(n)).filter((e=>e[1]));return Object.fromEntries(r)}read(e){return this.forage.getItem(e)}async write(e,t){await this.forage.setItem(e,t)}async delete(e){await this.forage.removeItem(e)}}class Ge{constructor(e){this.repo=e,this.scheduler=new g(100,(()=>this.push())),this.pending=[],ze(this,["readAll","read","write","delete"])}has(e){throw new Error("Do not use me")}async readAll(e){const t=await this.repo.readDir(e);return Object.fromEntries(t)}read(e){return this.repo.readFile(e)}write(e,t,n){const{urgent:r,reason:s}=Ne(n,`Update ${e}`);return this.commit(s,{[e]:t},r)}async delete(e,t){const{urgent:n,reason:r}=Ne(t,`Remove ${e}`);await this.commit(r,{[e]:null},n)}commit(e,t,n){if(!Object.keys(t).length)throw new Error("NO FILES TO COMMIT");return new Promise(((r,s)=>{this.pending.push({message:e,files:t,resolve:r,reject:s}),n?this.push(!0):this.scheduler.restart()}))}push(e=!1){if(this.repo.isCommiting)return void this.scheduler.restart();if(!this.pending.length)return;const t=[...this.pending];this.pending.length=0;const n=t.reduce(((e,t)=>a(a({},e),t.files)),{}),r=(s=t.map((e=>e.message)),Array.from(new Set(s)));var s;const o=r.length>1?`Multiple:\n- ${r.join("\n- ")}`:r[0];this.repo.commit(o,n,e).then((()=>t.forEach((e=>e.resolve()))),(e=>t.forEach((t=>t.reject(e)))))}}class Be{constructor(e,t){this.local=e,this.remote=t,ze(this,["readAll","read","write","delete"])}has(e){throw new Error("Do not use me")}localHas(e){return this.local.has(e)}readAll(e){return this.readAllRemote(e).catch((()=>this.readAllLocal(e)))}async readAllRemote(e){const[t,n]=await Promise.all([this.local.readAll(e),this.remote.readAll(e)]),r=Object.keys(t).filter((e=>!(e in n))).map((e=>this.local.delete(e))),s=Object.keys(n).filter((e=>n[e]!==t[e])).map((e=>this.local.write(e,n[e])));return Promise.all(s).then((()=>console.log(`${r.length} notes removed from local and ${s.length} updated`))),n}readAllLocal(e){return this.local.readAll(e)}read(e){return this.remote.read(e).then((t=>this.updateOffline(e,t)),(()=>this.local.read(e)))}readRemote(e){return this.remote.read(e).then((t=>this.updateOffline(e,t)))}readLocal(e){return this.local.read(e)}async write(e,t,n){await Promise.race([this.local.write(e,t,n),this.remote.write(e,t,n)])}async delete(e,t){await Promise.race([this.local.delete(e,t),this.remote.delete(e,t)])}deleteLocal(e){this.local.delete(e)}updateOffline(e,t){return null==t?this.local.delete(e):this.local.write(e,t),t}}class We extends Error{}const Ve=new p("pensieve.pending-commands",{default:[]}),Je=e=>Ve.set([...Ve.cache,e]);class Ke{constructor(e){this.remote=e,this.reading=new Map,this.reconnect=new g(1e3,(()=>this.executePending())),window.addEventListener("online",(()=>this.executePending())),ze(this,["readAll","read","write","delete"])}get isOffline(){return!navigator.onLine}has(e){throw new Error("Do not use me")}readAll(e){return this.rejectIfOffline()||this.remote.readAll(e)}read(e){if(this.reading.has(e))return this.reading.get(e);if(this.isOffline)return Promise.reject((()=>new We));const t=this.remote.read(e);return this.reading.set(e,t),t.finally((()=>this.reading.delete(e)))}write(e,t,n){return this.command("write",[e,t,n])}delete(e,t){return this.command("delete",[e,t])}rejectIfOffline(){if(this.isOffline)return Promise.reject(new We)}command(e,t,n=0){if(this.isOffline)return Je({method:e,params:t,attempts:n}),Promise.reject(new We);return this.remote[e](...t).catch((r=>{throw Je({method:e,params:t,attempts:n+1}),this.reconnect.restart(),r}))}executePending(){if(this.isOffline)this.reconnect.restart();else for(const{method:e,params:t,attempts:n}of(()=>{const e=[...Ve.cache];return Ve.reset(),e})())n<5?this.command(e,t,n):console.warn(`Command ${e} failed ${n} times`,...t)}}Object.assign(window,{localforage:f});class Qe{constructor(e,t){this.history=e,this.path=t,this.root="/",this.create="/new",this.settings="/settings",this.note="/note/:noteId",this.go=e=>this.history.push(e),this.goRoot=()=>this.history.push(this.root),this.goSettings=()=>this.history.push(this.settings),this.toNote=Ye((e=>this.note.replace(":noteId",e))),this.goNote=Ye((e=>this.history.push(this.note.replace(":noteId",e)))),this.isNote=Ye((e=>this.path===this.note.replace(":noteId",e)))}onNavigate(e){return this.history.listen((t=>e(new Qe(this.history,t.pathname))))}getPageName(){if("/"===this.path)return"home";const[,e]=this.path.split("/");return e}}function Xe(){const e=w();return new Qe(e,e.location.pathname)}function Ye(e){return t=>e("string"==typeof t?t:t.id)}function Ze({onClick:e}){return y.createElement("div",{className:"loader",onClick:e},y.createElement("div",{className:"container"},y.createElement("div",{className:"ripple"}),y.createElement("div",{className:"ripple ripple2"})))}const et=b.exports.createContext(null);function tt(){return b.exports.useContext(et)}function nt(){const e=tt(),t=Xe();return()=>{const n=e.create(`${ye()}.md\n`);t.goNote(n.id)}}let rt=0;function st(){const e=tt(),[t,n]=b.exports.useState(!0),[r,s]=b.exports.useState([]);return b.exports.useEffect((()=>{t||n(!0),e.all().then(o)}),[]),b.exports.useEffect((()=>{const t=r.map((t=>e.note(t.id))),n=[e.onNotesCreated(i),...t.map((e=>e.onChange(a))),...t.map((e=>{return e.onDelete((t=e.id,()=>{s(r.filter((e=>e.id!==t)))}));var t}))];return()=>n.forEach((e=>e()))}),[r]),[r,t];function o(e){if(i=e,(o=r).length!==i.length||!o.every(((e,t)=>Ee(e,i[t])))){const t=e.sort(((e,t)=>Number(be(t.created))-Number(be(e.created))));s(t)}var o,i;t&&n(!1)}function i(e){const t=e.map((e=>e.id)),n=r.filter((e=>!t.includes(e.id)));o([...e,...n])}function a(e){const{id:t}=e,n=r.findIndex((e=>e.id===t));if(-1===n)throw new Error(`Unknown note updated: ${t}`);o([...r.slice(0,n),e,...r.slice(n+1)])}}const ot=new p("pensieve.settings-hook",{version:1});function it(e){const[t,n,r]=function(){const e=tt(),[t,n]=b.exports.useState(!0),[r,s]=b.exports.useState(ot.cache||xe);return b.exports.useEffect((()=>(e.settings.get().then(o),e.settings.onChange(o))),[]),[r,async function(t){$e(t,r)||(ot.set(t),n(!0),s(t),await e.settings.set(t),n(!1))},{loading:t}];function o(e){$e(e,r)||(ot.set(e),s(e)),t&&n(!1)}}(),s=t[e],[,o]=b.exports.useState(s);return b.exports.useEffect((()=>{o(s);const t="boolean"!=typeof s?s:s?1:0;document.documentElement.style.setProperty(`--setting-${e}`,`${t}`)}),[fe(s)]),[s,function(r){fe(s)!==fe(r)&&n(c(a({},t),{[e]:r}))},r]}ot.get();const at={Meta:"META",Shift:"SHIFT",Alt:"ALT",Control:"CTRL"},ct={" ":"Space"},lt=d(),ut=lt.subscribe;q||document.addEventListener("keydown",(function(e){const t=[];e.metaKey&&t.push("META");e.ctrlKey&&t.push("CTRL");e.altKey&&t.push("ALT");e.shiftKey&&t.push("SHIFT");if(e.key in at)return;const n=function(e){return e in ct?ct[e]:e}(e.key);lt({key:e.key,keys:[...t.sort(),n],preventDefault:()=>e.preventDefault()})}),!0);const ht={};let dt=!1;function mt(e,t){const n=ht[e],r=tt();b.exports.useEffect((()=>(ht[e]=t,()=>{ht[e]=n}))),dt||function(e){let t=gt(Ce);const n=e=>t=gt(e);e.shortcuts.get().then(n),e.shortcuts.onChange(n),ut((e=>{const n=e.keys.join("+").toUpperCase();if(e.keys.length>1&&console.log(n),n in t){const r=t[n],s=ht[r]||null;console.log("Shortcut received",{keys:n,commandName:r,command:s}),"function"==typeof s&&(e.preventDefault(),s())}})),dt=!0}(r)}function gt(e){return Object.fromEntries(Object.entries(e).map((([e,t])=>{return[(n=e,n.toUpperCase().replace(/CMD|WINDOWS|WIN/,"META")),t];var n})))}function pt(e){return y.createElement("button",a({type:"button",role:"button"},e))}function ft({name:e,prefix:t="fas",className:n}){const[r,s]=e.includes(" ")?e.split(" "):[t,e];return y.createElement("i",{className:`${r} fa-${s} ${n||""}`})}function wt(e){const t=e,{icon:n,className:r}=t,s=l(t,["icon","className"]),o=`icon-button ${r||""}`;return y.createElement(pt,c(a({},s),{className:o}),y.createElement(ft,{name:n}))}function yt({className:e,onVisible:t,children:n}){var r;const s=b.exports.useRef(null),o=Boolean(null==(r=v.useIntersectionObserver(s,{}))?void 0:r.isIntersecting);return b.exports.useEffect((()=>{o&&t()}),[o]),y.createElement("div",{ref:s,className:e},n||"&nbsp;")}function bt(e){const[t,n]=b.exports.useState(!1),[r,s]=b.exports.useState(e.size),[o,i]=b.exports.useState([0,0]);return y.createElement("div",{className:"resizer",draggable:!0,onDragStart:e=>{n(!0),s(e.clientX),i([0,0])},onDrag:e=>{t&&i([o[1],e.clientX-r])},onDragEnd:()=>{const t=r+o[0];n(!1),s(t),e.onChange(t)}})}function vt(e,t){const[n]=b.exports.useState({callback:t}),[r]=b.exports.useState(new g(e,(()=>n.callback())));return n.callback=t,r}const Et=/\s+/g;class kt{constructor(e){this.clean=xt(e)}fullMatch(e){return xt(e)===this.clean}matches(e){return!this.clean||xt(e).includes(this.clean)}matchesAny(e){return e.filter(Boolean).some((e=>this.matches(e)))}}function xt(e){return e.toLowerCase().replace(Et,"")}function $t({onChange:e}){const t=b.exports.createRef(),[n,r]=b.exports.useState(""),s=vt(50,(()=>e(n?new kt(n):null)));return mt("clearFilter",(()=>o(""))),y.createElement(y.Fragment,null,y.createElement("input",{ref:t,className:"filter-box",type:"text",placeholder:"Filter...",defaultValue:n,onChange:e=>o(e.target.value)}),n?y.createElement(wt,{icon:"times",onClick:()=>o("")}):null);function o(e){t.current&&(t.current.value=e),r(e),s.restart()}}function Ct(e){const t=tt(),n=t.note(e),[r,s]=b.exports.useState(n.get()),[o,i]=b.exports.useState(!r);return b.exports.useEffect((()=>{const e=n.get();e?a(e):i(!0);const t=[n.onChange(a),n.onDraft(a)];return()=>t.forEach((e=>e()))}),[e]),[r,{loading:o,toggleFavorite:()=>t.note(e).toggleFavorite(),remove:()=>t.note(e).delete(),draft:n=>t.note(e).draft(n)}];function a(e){Ee(e,r)||s(e),o&&i(!1)}}function St({title:e}){return y.createElement("svg",{"aria-hidden":!0,"aria-label":e,xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24"},y.createElement("title",null,e),y.createElement("path",{d:"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"}))}function Nt({id:e}){const t=Xe(),n=b.exports.useContext(et).username,[r,{toggleFavorite:s,remove:o}]=Ct(e),[i,l]=b.exports.useState(t.isNote(e));if(b.exports.useEffect((()=>t.onNavigate((t=>{const n=t.isNote(e);(i||n)&&l(n)})))),!r)return null;const u=`https://github.com/${n}/pensieve-data/blob/main/note/${r.id}`,h=["note-item",r.favorite?"favorite":"",i?"active":""],d=r.group?{"data-group":r.group}:{},m=y.createElement("a",{target:"_blank",href:u,onClick:e=>e.stopPropagation()},y.createElement(St,{title:"Open note in Github"}));return y.createElement(E,c(a({className:h.join(" ")},d),{to:t.toNote(r)}),y.createElement("div",{className:"star-part"},y.createElement(wt,{icon:r.favorite?"star":"far star",onClick:function(e){e.preventDefault(),s()}})),y.createElement("h5",{className:"title-part"},r.title),y.createElement("div",{className:"actions-part"},m,y.createElement(wt,{icon:"trash",onClick:function(n){if(!confirm(`Delete ${r.title}?`))return;n.preventDefault(),t.isNote(e)&&t.goRoot();return o()}})))}const At=e=>`group-open:${e}`;function Rt({group:e,notes:t}){const n=e=>t.some((t=>e.isNote(t))),r=(e=>Boolean(localStorage[At(e)]))(e),s=Xe(),[o,i]=b.exports.useState(n(s));b.exports.useEffect((()=>s.onNavigate((e=>{const t=n(e);o!==t&&i(t)}))));const a=t.filter((e=>e.favorite)),c=["group",o?"has-active":"",a.length?"has-favorite":""];return y.createElement("details",{className:c.join(" "),"data-group":e,open:r},y.createElement("summary",{className:"group-title",onClick:Tt},y.createElement(ft,{name:"angle-right",className:"icon-button group-caret"}),y.createElement("span",{className:"group-name"},e),a.length?y.createElement(y.Fragment,null,y.createElement("i",{className:"fav-counter"},a.length)," /"):null,y.createElement("i",{className:"counter"},t.length)),y.createElement("ul",{className:"group-content"},t.map((e=>y.createElement(Nt,{key:e.id,id:e.id})))))}function Tt(e){const t=e.currentTarget.parentElement,n=t.hasAttribute("open"),r=At(t.dataset.group);console.debug(`> ${r}: ${!n}`),n?localStorage.removeItem(r):localStorage.setItem(r,"true")}function Ot(){const e=nt(),[t,n]=b.exports.useState(50),[r,s]=st(),[o,i]=b.exports.useState(null),c=function(e,t){const[n,r]=b.exports.useState([]),[s,o]=b.exports.useState(0),i=tt();if(b.exports.useEffect((()=>{t&&(o(0),r(e.filter((e=>t.matchesAny([e.id,e.title,e.group])))))}),[e,t]),!t)return e;const a=++rt;return setTimeout((async function(){if(a===rt)for(let a=s;a<e.length;a++){const s=e[a];if(n.includes(s))continue;const c=i.note(s.id);if(await c.hasCachedContent){const e=await c.read();if(t.matches(e)){o(a+1),r([...n,s]);break}}}}),10),n}(r,o),[l,u]=it("sidebarVisible"),[h,d]=it("sidebarWidth");mt("newNote",e),mt("hideSidebar",(()=>u(!l)));const m=b.exports.useCallback((()=>{const e=t+50;console.debug(`🚅 Loading 50 more items: ${e}`),n(e)}),[t]);if(!l&&"/"!==location.pathname)return null;const g=o?{"data-filter":!0}:{};return y.createElement("aside",null,y.createElement("h4",{className:"filter"},y.createElement($t,{onChange:i}),y.createElement(wt,{icon:"plus",onClick:e})),y.createElement("div",a({className:"notes-list"},g),s?y.createElement(Ze,null):function(){const e=new Map,n=[...c.filter((e=>e.favorite)),...c.filter((e=>!e.favorite))].map((t=>{var n;const{group:r}=t;return r?e.has(r)?(null==(n=e.get(r))||n.push(t),null):(e.set(r,[t]),r):t})).filter((e=>Boolean(e))),r=n.slice(0,t),s=n.length>50?"No more notes":null;return console.debug(`🚅 Rendering ${r.length} of ${n.length}`),y.createElement(y.Fragment,null,r.map((t=>{if("string"!=typeof t)return y.createElement(Nt,{key:t.id,id:t.id});const n=t,r=e.get(n);return y.createElement(Rt,{key:`group/${n}`,group:n,notes:r})})),y.createElement(yt,{className:"notes-list__end",onVisible:m},t<n.length?y.createElement(Ze,{onClick:m}):s))}()),y.createElement(bt,{size:h,onChange:d}))}function Pt(){const e=nt();return b.exports.useEffect(e,[]),y.createElement(Ze,null)}const{isHidden:jt,visibilitychange:It}=function(){null==document.addEventListener&&Ut("Page Visibility API");if(null!=document.hidden)return{isHidden:"hidden",visibilitychange:"visibilitychange"};if(null!=document.msHidden)return{isHidden:"msHidden",visibilitychange:"msvisibilitychange"};if(null!=document.webkitHidden)return{isHidden:"webkitHidden",visibilitychange:"webkitvisibilitychange"};Ut("Page Visibility API")}(),Lt=k(window,"pageshow"),Dt=k(window,"pagehide"),Mt=k(window,"freeze"),Ft=k(window,"resume"),qt=k(window,"beforeunload"),zt=k(document,It).pipe(x((()=>!document[jt]))).pipe($(Lt.pipe(x((()=>!0))),Dt.pipe(x((()=>!1))),Mt.pipe(x((()=>!0))),Ft.pipe(x((()=>!1))),qt.pipe(x((()=>!1)))),C());function Ut(e){class t extends Error{constructor(e){super(`This feature requires a browser, such as Google Chrome or Firefox, that supports ${e}.`)}}throw new t(e)}function Ht(e){return new S((t=>e.subscribe((e=>t.next(e)))))}function _t(){const[e,t]=b.exports.useState(!1);return b.exports.useEffect((()=>Y(t))),e?y.createElement("div",{className:"business-indicator"},y.createElement(ft,{name:"circle-notch",className:"business-indicator--icon"})):null}function Gt(e,t,...n){try{return e()}catch(r){console.error(`ERROR: ${t}`),console.debug(`ERROR: ${t}`),console.debug(r),n.length&&console.debug("Reported debug values:",...n)}}function Bt(e,t){const n=Object.entries(t).map((([e,t])=>{const n=Gt((()=>function(e){const t=new RegExp(e,"g");return e=>{const n=e.getLinesContent(),r=[];let s=0,o=0;for(let i=0;i<n.length;i++){const e=n[i];for(const n of e.matchAll(t)){const e=n[0],t=Array.from(n),a=i,c=n.index,l=new A(a+1,c+1,a+1,c+1+e.length);r.push({text:e,capture:t,row:a,col:c,prevLine:s,prevChar:o,range:l}),s=i,o=n.index}}return r}}(e)),"Invalid regex pattern for link",e,t);return n?e=>n(e).map((({range:e,capture:n})=>({range:e,url:Wt(t,n)}))):null})).filter(Vt);e.languages.registerLinkProvider("markdown",{provideLinks:e=>({links:n.flatMap((t=>t(e)))})})}function Wt(e,t){if("string"!=typeof e)throw new Error("URL pattern is not a string: "+typeof e);const n=e.replace(/\$(\d+)/g,((e,n)=>t[n]||""));return Gt((()=>T.parse(n)),`Invalid URL generated from settings: ${n}`,e,t)}function Vt(e){return null!=e}N.IMonarchLanguage,R.ITextModel;const Jt="pensieve";var Kt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",automaticLayout:!0,contextmenu:!1,renderLineHighlight:"none",theme:Jt});function Qt(e,t,n){if(n&&Gt((()=>Bt(e,n)),'Error in "links" entry from settings. Should be an Array<[string, string]>',n),!t)return;const r=[],s=[];let o=0;Gt((()=>{for(const[e,n]of Object.entries(t)){Gt((()=>new RegExp(e)),"Invalid regex pattern for highlighting",e);const t=`autotoken${o}`;s.push([e,t]),r.push({token:t,foreground:n}),o++}}),"Error processing highlight in settings. Should be an Array<[string, string]>",t),Gt((()=>async function(e,t,n){const r=e.languages.getLanguages().find((({id:e})=>e===t));if(!r)throw new Error(`Could not find language ${t}`);const{language:s}=await r.loader(),o=n,{tokenizer:i}=o,a=l(o,["tokenizer"]);for(const[c,l]of Object.entries(i))s.tokenizer.hasOwnProperty(c)||(s.tokenizer[c]=[]),Array.isArray(l)&&s.tokenizer[c].unshift(...l);for(const[c,l]of Object.keys(a))Array.isArray(l)&&(s.hasOwnProperty(c)||(s[c]=[]),s[c].unshift(...l))}(e,"markdown",{tokenizer:{root:s}})),"Error from extending monaco's language",s),Gt((()=>function(e,t,n){e.editor.defineTheme(Jt,{base:t,inherit:!0,colors:{},rules:n})}(e,"vs-dark",r)),"Error from extending monaco's theme",r)}function Xt({language:e,value:t,gap:n,readonly:r,autofocus:s,onChange:o}){const i=b.exports.createRef(),a=O(),[c]=it("links"),[l]=it("highlight"),[u,h]=b.exports.useState(!0);return b.exports.useEffect((()=>{a&&Qt(a,l,c)}),[a,l,c]),b.exports.useEffect((()=>{a&&i.current&&a.editor.colorizeElement(i.current,{theme:Jt})}),[a,i.current]),u?y.createElement("pre",{className:"mobile-fallback mobile-fallback--code",onClick:()=>h(!1)},y.createElement("code",{ref:i,lang:e,"data-lang":e},t)):y.createElement("textarea",{ref:e=>null==e?void 0:e.style.setProperty("--toolbar-height",`${n||0}px`),className:"mobile-fallback mobile-fallback--textarea",defaultValue:t,readOnly:r,autoFocus:s,autoComplete:"",onChange:e=>o(e.target.value)})}R.BuiltinTheme,R.ITokenThemeRule,N.IMonarchLanguageRule,R.ITokenThemeRule;function Yt({value:e,ext:t,gap:n,readonly:r,onChange:s}){const o=O(),[i]=it("links"),[l]=it("rulers"),[u]=it("tabSize"),[h]=it("wordWrap"),[d]=it("highlight"),[m]=it("renderIndentGuides"),g=e.split("\n").length,{extension:p}=ke(e),f=function(e){if(!o)return null;const t=o.languages.getLanguages().find((t=>{var n;return null==(n=t.extensions)?void 0:n.includes(e)}));return null==t?void 0:t.id}(t||p)||"markdown";return q?y.createElement(Xt,c(a({},{gap:n,language:f,value:e,readonly:r,onChange:s}),{autofocus:!0})):y.createElement(P,{className:"editor",height:n?`calc(100vh - ${n}`:"100vh",theme:Jt,language:f,value:e,options:(w="markdown"===f,c(a({},Kt),{"semanticHighlighting.enabled":!0,minimap:{enabled:g>100},readOnly:r,renderIndentGuides:m,rulers:l,tabSize:u,wordBasedSuggestions:!w,wordWrap:h?"on":"off"})),onChange:s,beforeMount:e=>Qt(e,d,i),onMount:e=>e.focus()});var w}function Zt(e){const{title:t,content:n,ext:r,gap:s}=e,o=function(e){return"readonly"in e}(e)||!1,i=d(),l=d(),u=w(),h=it("autosave")[0]||0,[m,g]=function(e,t){const[n]=b.exports.useState([]);return b.exports.useEffect((()=>{void 0!==t&&n.push(t)}),[]),[n,function(t){n.unshift(t),n.length>e&&(n.length=e)}]}(5,n),[p,f]=b.exports.useState(!1),[v,E]=b.exports.useState(n),k=vt(1e3*h,(()=>{0!==h&&i()}));if(mt("save",S),b.exports.useEffect((()=>{document.title=`${t}  ✏️  Pensieve`}),[t]),b.exports.useEffect((()=>{if(en(e)&&e.saveOnNavigation)return u.listen((()=>i()))})),b.exports.useEffect((()=>{m.includes(n)||(f(!1),E(n))}),[n]),b.exports.useEffect((()=>{if(!p)return;const e=zt.subscribe((e=>{e||l()}));return()=>e.unsubscribe()})),null==v)return y.createElement(Ze,null);const C=Ht(l).pipe(x((()=>({urgent:!0}))));return Ht(i).pipe(j(100),$(C)).subscribe((e=>p&&S(e||{}))),y.createElement("div",null,y.createElement(Yt,c(a({},{ext:r,gap:s,value:v,readonly:o}),{onChange:function(t=""){en(e)||tn();f(t!==n),E(t),e.onChange&&e.onChange(t),k.restart()}})),y.createElement(_t,null));function S({urgent:t=!1}={}){p||console.warn("Possibly creating an empty commit!"),en(e)||tn(),k.stop(),g(v);const n=function(e){const t=e.replace(/ +\n| +$/g,"\n");if("\n"===t[t.length-1])return t;return`${t}\n`}(v);return g(n),f(!1),e.onSave(n,{urgent:t})}}function en(e){return"onSave"in e}function tn(){throw new Error("How the fuck did you get here???")}function nn(){const{noteId:e}=I(),t=Xe(),[n,{loading:r,draft:s}]=Ct(e),[o,i]=function(e){const t=tt(),[n,r]=b.exports.useState(!0),[s,o]=b.exports.useState("");return b.exports.useEffect((()=>{o(""),n||r(!0);const s=t.note(e);return s.read().then(i),s.onContentChange(i)}),[e]),[s,function(n,s){r(!0),t.note(e).write(n,s)},n];function i(e){e!==s&&o(e||""),n&&r(!1)}}(e);return r?y.createElement(Ze,null):n?y.createElement(Zt,{key:n.id,title:n.title,content:o,saveOnNavigation:!0,onChange:s,onSave:i}):(console.error(`Note ${e} not found`),t.goRoot(),null)}function rn(e){const[t,n]=b.exports.useState(!0),[r,s]=b.exports.useState("");return b.exports.useEffect((()=>{const t=()=>e.read().then((e=>s(e))).finally((()=>n(!1)));return t(),e.onChange(t)}),[]),[r,function(t,n){if(!function(e){try{return we(e),!0}catch(t){return!1}}(t))return alert("Invalid JSON");e.write(t,n)},t]}function sn(){const e=tt(),[t,n]=b.exports.useState(0),[r,s,o]=rn(e.settings),[i,c,u]=rn(e.shortcuts),h=[{title:"Settings",content:r,loading:o,onSave:s},{title:"Shortcuts",content:i,loading:u,onSave:c},{title:"Default settings",content:fe(xe),loading:!1,readonly:!0},{title:"Default shortcuts",content:fe(Ce),loading:!1,readonly:!0}],d=h[t],{loading:m}=d,g=l(d,["loading"]);return y.createElement("div",{className:"settings-editor"},y.createElement("nav",null,h.map(((e,t)=>y.createElement("div",{key:e.title,className:"tab",onClick:()=>n(t)},e.title)))),m?y.createElement(Ze,null):y.createElement(Zt,a({key:g.title,gap:"33px",ext:".json"},g)))}function on(){const e=Xe();return mt("settings",(()=>e.goSettings())),y.createElement(y.Fragment,null,y.createElement(L,{path:e.create,component:Pt}),y.createElement(L,{path:e.settings,component:sn}),y.createElement(L,{path:e.note,component:nn}))}const an=encodeURIComponent,cn=decodeURIComponent;function ln(e,t={}){const n=Object.entries(t).map((([e,t])=>`${an(e)}=${an(t)}`)).join("&");return n.length?`${e}?${n}`:e}function un(e){const[,t]=e.split("?");return t?Object.fromEntries(t.split("&").map((e=>{const[t,n]=e.split("=");return[cn(t),cn(n)]}))):{}}class hn{constructor(e){this.rest=new ue(e)}async fetchCurrentUsername(){return(await this.rest.GET("/user")).login}}const dn="localhost"===location.hostname,mn=new class{constructor(e){this.requestState=new p("notes.gh-state",{default:"init",version:1}),this.auth=new p("notes.gh-token",{default:null,version:1}),this.clientId=e.clientId,this.scope=e.scope,this.redirectUri=e.redirectUri,this.endpoint=e.endpoint}get token(){return this.auth.cache}get headers(){return{Authorization:`token ${this.token}`,Accept:"application/vnd.github.v3+json"}}get state(){return this.requestState.cache}requestGithubAuthorization(){const e=Math.random().toString().substr(2),t=ln("https://github.com/login/oauth/authorize",{client_id:this.clientId,scope:this.scope,redirect_uri:this.redirectUri,state:e});this.requestState.set(e),location.replace(t)}async processGithubAuthCode(e,t){if(t&&t!==this.state)throw new Error(`Request state do not match: "${t}" - "${this.state}`);e&&this.requestState.reset();const n=await this.requestAccessToken(e,t),{access_token:r}=un(`/?${n}`);return this.auth.set(r),r}requestAccessToken(e,t){const n=ln(this.endpoint,{redirect_uri:this.redirectUri,state:t,code:e});return ne(n)}}({scope:"repo gist",endpoint:"https://pensieve.amatiasq.com/auth",clientId:dn?"c55d2c46c215f9a4c3cb":"09580e62d66243b6b09d",redirectUri:dn?location.origin:"https://pensieve.amatiasq.com/"}),gn=new p("notes.gh-user",{default:null,version:1});function pn(){const{code:e,state:t}=un(location.toString()),[n,r]=b.exports.useState(mn.token&&gn.cache?{token:mn.token,username:gn.cache}:null);return e?(history.replaceState(null,document.title,location.pathname),async function(e,t){const n=await mn.processGithubAuthCode(e,t),r=new hn(n),s=await r.fetchCurrentUsername();return gn.set(s),{token:n,username:s}}(e,t).then(r),{}):n||("/halt"===location.pathname||mn.requestGithubAuthorization(),{})}function fn(){const[e,t]=b.exports.useState(null),{token:n,username:r}=pn(),s=Xe(),[o,i]=b.exports.useState(s.getPageName());return b.exports.useEffect((()=>{n&&r&&async function(e,t,n){const r=new de(e,t,n);if(navigator.onLine){const e=r.createIfNecessary("Database for notes",!0).catch((()=>!1));await e&&window.location.reload()}const s=new _e(f.createInstance({name:n})),o=new Ge(r),i=new Ke(o),a=new Be(new He(s,5,"local"),new He(i,30,"remote"));return new Me(t,a)}(n,r,"pensieve-data").then(t)}),[n]),b.exports.useEffect((()=>s.onNavigate((e=>i(e.getPageName()))))),b.exports.useEffect((()=>{const e=new AbortController;return document.body.addEventListener("click",(e=>function(e,t,n){if("A"!==t.tagName)return;const{href:r}=t.dataset;if(!(null==r?void 0:r.startsWith(location.origin)))return;e.preventDefault(),e.stopImmediatePropagation(),n(r.replace(location.origin,""))}(e,e.target,s.go)),{capture:!0,signal:e.signal}),()=>e.abort()}),[s.go]),e?y.createElement(et.Provider,{value:e},y.createElement("div",{className:`app page-${o}`},y.createElement(Ot,null),y.createElement("main",null,y.createElement(on,null)))):y.createElement(Ze,null)}const wn=document.getElementById("app-container");if(!wn)throw new Error("Missing container element");var yn;yn=wn,D.exports.render(y.createElement(M,null,y.createElement(fn,null)),yn),V((e=>{e?wn.classList.add("is-virtual-keyboard-open"):wn.classList.remove("is-virtual-keyboard-open")})),function(e={}){const{immediate:t=!1,onNeedRefresh:n,onOfflineReady:r}=e;let s,o;if("serviceWorker"in navigator){s=new u("/sw.js",{scope:"/"}),s.addEventListener("activated",(e=>{e.isUpdate||null==r||r()}));{const e=()=>{null==n||n()};s.addEventListener("waiting",e),s.addEventListener("externalwaiting",e)}s.register({immediate:t}).then((e=>o=e))}}({onNeedRefresh(){alert("New version downloaded. Please refresh the page")},onOfflineReady(){console.log("📡 Offline ready")}});
